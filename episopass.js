// Generated by CoffeeScript 2.5.1
(function() {
    // Facebookなどのログイン画面でEpisoPassを呼び出すブラウザ拡張機能
  // ChromeでもFirefoxでも使えるはず

  var episodata;

  episodata = []; 

  $(function() {
    var data, idelement, passelement, service;
    passelement = [];
    idelement = null;
    service = '';
    if (location.href.match(/facebook.com/)) {
      passelement = $('#pass');
      idelement = $('#email');
      service = 'Facebook';
    }
    if (location.href.match(/amazon/)) {
      passelement = $('#ap_password');
      idelement = $('#ap_email');
      service = 'Amazon';
    }
    if (location.href.match(/linkedin.com/)) {
      // passelement = $('#login-password')
      // idelement = $('#login-email')
      passelement = $('#password');
      idelement = $('#username');
      service = 'LinkedIn';
    }
    if (location.href.match(/twitter.com/)) {
      passelement = $('.js-password-field');
      idelement = $('.text-input');
      // idelement = $('.email-input')
      service = 'Twitter';
    }
    if (location.href.match(/github.com/)) {
      idelement = $('#login_field');
      passelement = $('#password');
      service = 'GitHub';
    }
    if (location.href.match(/value-domain.com/)) {
      idelement = $('#username');
      passelement = $('#password');
      service = 'ValueDomain';
    }
    if (location.href.match(/heroku.com/)) {
      idelement = $('#email');
      passelement = $('#password');
      service = 'Heroku';
    }
    if (location.href.match(/pinterest\./)) {
      idelement = $('#email');
      passelement = $('#password');
      service = 'Pinterest';
    }
    if (location.href.match(/tumblr.com/)) {
      idelement = $('#signup_email');
      passelement = $('#signup_password');
      service = 'Tumblr';
    }
    if (location.href.match(/gyazo.com/)) {
      idelement = $('input[name="email"]');
      passelement = $('input[name="password"]');
      service = 'Gyazo';
    }
    console.log(service);
    console.log(idelement);
    console.log(passelement);
    // セーブされてるEpisoPassデータを読む
    //episodata = []
    //chrome.storage.local.get "episodata", (value) ->
    //  if Object.keys(value).length == 0
    //    episodata = []
    //  else
    //    episodata = value.episodata

    // EpisoPass問題ページか判定

    if ($('#question') && $('#question').length > 0) {
      
      // 新しいデータを追加

      data = JSON.parse($('body').attr('episodata'));
      episodata = [];
      chrome.storage.local.get("episodata", function(value) {
        var entry, i, len, newdata;
        if (Object.keys(value).length === 0) {
          episodata = [];
        } else {
          episodata = value.episodata;
        }
        // 古いのを消す
        newdata = [];
        for (i = 0, len = episodata.length; i < len; i++) {
          entry = episodata[i];
          console.log("each - " + entry.name);
          if (entry.name !== data.name) {
            newdata.push(entry);
          }
        }
        episodata = newdata;
        // 新しいのを足す
        episodata.push(data);
        
        // データをセーブ
        return chrome.storage.local.set({
          'episodata': episodata
        }, function() {
          console.log("saved episodata");
          return console.log(episodata);
        });
      });
    }
    
    // パスワード入力画面か判定し、

    if (idelement && passelement && passelement[0] !== void 0 && passelement.val() === '') {
      return passelement.on('click', function() {
        var id, name;
        if (!window.clicked) {
          id = idelement.val();
          if (!id || id === '') {
            id = 'masui';
          }
          name = `${service}_${id}`;
          alert(name);
          // セーブされてるデータを読む
          chrome.storage.local.get("episodata", function(value) {
            var div, entry, i, len, results;
            episodata = value.episodata;
            results = [];
            for (i = 0, len = episodata.length; i < len; i++) {
              entry = episodata[i];
              if (entry.name === name) {
                div = $('<div>').css('position', 'absolute').css('left', '200px').css('top', '200px').css('width', '400px').css('height', '450px').css('background-color', '#ddd').css('border-radius', '5px').css('z-index', 100).attr('id', 'episopass');
                $('body').append(div);
                results.push(exports.run(entry, id, entry.seed, passelement));
              } else {
                results.push(void 0);
              }
            }
            return results;
          });
        }
        return window.clicked = true;
      });
    }
  });

}).call(this);
